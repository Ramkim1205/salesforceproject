public with sharing class TechnicianAssignmentHelper {
    
    @InvocableMethod(label='Assign Technician to Installation' description='Finds and assigns the best technician')
    public static void assignTechnicianToInstallation(List<Id> oppIds) {
        if (oppIds == null || oppIds.isEmpty()) return;
        
        System.debug('ğŸ”¹ Received Opportunity IDs: ' + oppIds);
        List<Installation__c> installationsToInsert = new List<Installation__c>();
        List<TechnicianSchedule__c> schedulesToInsert = new List<TechnicianSchedule__c>();
        
        // 1ï¸âƒ£ Opportunity ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        List<Opportunity> oppList = [
            SELECT Id, District__c, Scheduled_Date__c, Scheduled_Time__c
            FROM Opportunity 
            WHERE Id IN :oppIds
        ];
        
        for (Opportunity opp : oppList) {
            if (opp.District__c == null || opp.Scheduled_Date__c == null || opp.Scheduled_Time__c == null) {
                System.debug('âš ï¸ Missing Scheduling Data for Opportunity: ' + opp.Id);
                continue;
            }
            
            System.debug('ğŸ”¹ Processing Opportunity: ' + opp.Id + ', District: ' + opp.District__c);
            
            // 2ï¸âƒ£ í•´ë‹¹ Districtë¥¼ ë‹´ë‹¹í•˜ëŠ” Technician ì¡°íšŒ (Multi-Picklist ì§€ì›)
            List<Technician__c> availableTechnicians = [
                SELECT Id, Name, User__c, District__c, Assigned_Installations__c 
                FROM Technician__c
                WHERE District__c INCLUDES (:opp.District__c)
            ];
            
            if (availableTechnicians.isEmpty()) {
                System.debug('âš ï¸ No available Technicians for District: ' + opp.District__c);
                continue;
            }
            
            System.debug('âœ… Found ' + availableTechnicians.size() + ' available Technicians');
            
            // 3ï¸âƒ£ í•´ë‹¹ ì‹œê°„ì— ì„¤ì¹˜ê°€ ë°°ì •ë˜ì§€ ì•Šì€ Technician ì°¾ê¸°
            Set<Id> technicianIds = new Set<Id>();
            for (Technician__c tech : availableTechnicians) {
                technicianIds.add(tech.Id);
            }
            
            // í•´ë‹¹ Technicianë“¤ì—ê²Œ ì´ë¯¸ ë°°ì •ëœ Installation ì¤‘, ê°™ì€ ë‚ ì§œ + ê°™ì€ ì‹œê°„ì— ì§„í–‰ë˜ëŠ” ì‘ì—… ì¡°íšŒ
            Map<Id, Integer> assignedInstallationCounts = new Map<Id, Integer>();
            for (AggregateResult ar : [
                SELECT Technician__c, COUNT(Id) assignedCount
                FROM Installation__c
                WHERE Technician__c IN :technicianIds
                AND Scheduled_Date__c = :opp.Scheduled_Date__c
                AND Scheduled_Time__c = :opp.Scheduled_Time__c
                GROUP BY Technician__c
            ]) {
                assignedInstallationCounts.put((Id) ar.get('Technician__c'), (Integer) ar.get('assignedCount'));
            }
            
            // 4ï¸âƒ£ ì„¤ì¹˜ê°€ ê°€ëŠ¥í•œ Technician í•„í„°ë§ (ì´ë¯¸ í•´ë‹¹ ì‹œê°„ëŒ€ì— Installationì´ ì—†ëŠ” Technician)
            List<Technician__c> availableForTimeSlot = new List<Technician__c>();
            for (Technician__c tech : availableTechnicians) {
                if (!assignedInstallationCounts.containsKey(tech.Id)) {
                    availableForTimeSlot.add(tech);
                }
            }
            
            // 5ï¸âƒ£ ê°€ì¥ ì ì€ Installationì„ ê°€ì§„ Technician ì„ íƒ
            Technician__c assignedTechnician;
            Decimal minInstallations = 20000.0;
            for (Technician__c tech : availableForTimeSlot) {
                Integer assignedCount = tech.Assigned_Installations__c != null ? tech.Assigned_Installations__c.intValue() : 0;
                if (assignedCount < minInstallations) {
                    minInstallations = assignedCount;
                    assignedTechnician = tech;
                }
            }
            
            if (assignedTechnician == null) {
                System.debug('âš ï¸ No Technician assigned for Opportunity: ' + opp.Id);
                continue;
            }
            
            System.debug('âœ… Assigned Technician: ' + assignedTechnician.Id);
            
            // 6ï¸âƒ£ Installation ìƒì„± (`Technician__c` í•„ë“œì— ë°°ì •)
            Installation__c newInstallation = new Installation__c(
                Opportunity__c = opp.Id,
            Technician__c = assignedTechnician.Id,
            Scheduled_Date__c = opp.Scheduled_Date__c,
            Scheduled_Time__c = opp.Scheduled_Time__c,
            Status__c = 'Scheduled'
                );
            installationsToInsert.add(newInstallation);
            
            // 7ï¸âƒ£ Technicianì˜ ìŠ¤ì¼€ì¤„ ì¶”ê°€ (`TechnicianSchedule__c`)
            TechnicianSchedule__c newSchedule = new TechnicianSchedule__c(
                Technician__c = assignedTechnician.Id,
            Schedule_Date__c = opp.Scheduled_Date__c,
            Schedule_Time__c = opp.Scheduled_Time__c
                );
            schedulesToInsert.add(newSchedule);
        }
        
        if (!installationsToInsert.isEmpty()) {
            insert installationsToInsert;
            System.debug('âœ… Inserted ' + installationsToInsert.size() + ' new Installation records');
        }
        
        if (!schedulesToInsert.isEmpty()) {
            insert schedulesToInsert;
            System.debug('âœ… Inserted ' + schedulesToInsert.size() + ' new Technician Schedule records');
        }
    }
}